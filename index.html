<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–Ø–Ω–¥–µ–∫—Å –î–¢–ü</title>
    <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç -->
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=3de168ba-04ed-42f5-bb4e-6abff9b3f317" type="text/javascript"></script>
</head>
<body>
    <div id="map"></div>

    <script>
    ymaps.ready(init);

    function init() {
        var myMap = new ymaps.Map("map", {
            center: [51.6833, 39.1802],
            zoom: 13,
            controls: []
        });

        var actualProvider = new ymaps.traffic.provider.Actual({}, { infoLayerShown: true });
        actualProvider.setMap(myMap);

        var infoLayer = new ymaps.traffic.InfoLayer(myMap, { provider: actualProvider });
        infoLayer.setMap(myMap);

        // ===== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram =====
        const BOT_TOKEN = "8309884289:AAH4b64WzSEf8en2ZbFNl2DQ-iOSBlTYiJc"; // <- –≤—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ —Ç–æ–∫–µ–Ω –æ—Ç BotFather
        const CHAT_ID = "7523840597";       // <- –≤—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ chat_id –∏–ª–∏ @username

        // –•—Ä–∞–Ω–∏–ª–∏—â–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –î–¢–ü —á–µ—Ä–µ–∑ localStorage
        let sent = JSON.parse(localStorage.getItem('sentAccidents') || "[]");
        sent = new Set(sent); // –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ Set –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞

        function saveSent() {
            localStorage.setItem('sentAccidents', JSON.stringify([...sent]));
        }

        async function checkAccidents() {
            const overlays = myMap.geoObjects.toArray();

            overlays.forEach(obj => {
                try {
                    const props = obj.properties?.getAll?.();
                    if (!props) return;

                    const name = props.name || "";
                    const description = props.description || "";

                    if (name.includes("–î–¢–ü") || description.includes("–î–¢–ü")) {
                        const coords = obj.geometry.getCoordinates();
                        const id = coords.join(",");

                        if (!sent.has(id)) {
                            sent.add(id);
                            saveSent();

                            const text = `üö® <b>–î–¢–ü –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ!</b>\n` +
                                         `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${coords[0].toFixed(5)}, ${coords[1].toFixed(5)}\n` +
                                         `<a href="https://yandex.ru/maps/?pt=${coords[1]},${coords[0]}&z=16&l=map">–û—Ç–∫—Ä—ã—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ</a>`;

                            fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                                method: "POST",
                                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                                body: `chat_id=${CHAT_ID}&text=${encodeURIComponent(text)}&parse_mode=HTML`
                            });
                        }
                    }
                } catch (e) {
                    console.warn(e);
                }
            });
        }

        // –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ —Å—Ä–∞–∑—É
        checkAccidents();

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç
        setInterval(checkAccidents, 10 * 60 * 1000);
    }
    </script>
</body>
</html>
